{"componentChunkName":"component---src-templates-post-jsx","path":"/aws-amplify/","result":{"data":{"site":{"siteMetadata":{"title":"onseok.blog"}},"markdownRemark":{"id":"8e7bdff8-a60d-50a5-aa84-fbc6f7569ebb","excerpt":"AWS Amplify는 모바일 및 프런트엔드 개발자가 AWS에서 안전하고 확장 가능한 풀스택 애플리케이션을 구축하고 배포할 수 있도록 지원하는 제품입니다. 회사에서 서비스하고 있는 프로젝트에서 S3로 로그 파일을 주기적으로 업로드하는 기능을 구현하고 꾸준히 모니터링하였는데, 여러 Android 기기에서 java.lang.OutOfMemoryError 오류…","html":"<p>AWS Amplify는 모바일 및 프런트엔드 개발자가 AWS에서 안전하고 확장 가능한 풀스택 애플리케이션을 구축하고 배포할 수 있도록 지원하는 제품입니다. 회사에서 서비스하고 있는 프로젝트에서 S3로 로그 파일을 주기적으로 업로드하는 기능을 구현하고 꾸준히 모니터링하였는데, 여러 Android 기기에서 <a href=\"https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/memleaks002.html\">java.lang.OutOfMemoryError</a> 오류가 반복적으로 발생하는 것을 발견했습니다.</p>\n<h3 id=\"원인을-분석해보자\" style=\"position:relative;\"><a href=\"#%EC%9B%90%EC%9D%B8%EC%9D%84-%EB%B6%84%EC%84%9D%ED%95%B4%EB%B3%B4%EC%9E%90\" aria-label=\"원인을 분석해보자 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>원인을 분석해보자</h3>\n<p>수집된 크래시 리포트를 요약하면 다음과 같았습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Fatal Exception: java.lang.OutOfMemoryError: Failed to allocate a 8388620 byte allocation with 8388608 free bytes and 19MB until OOM\n       at java.util.IdentityHashMap.resize(IdentityHashMap.java:476)\n       at java.util.IdentityHashMap.put(IdentityHashMap.java:452)\n       ...\n       at com.amplifyframework.storage.s3.transfer.TransferWorkerObserver$attachObserver$2.invokeSuspend(TransferWorkerObserver.kt:199)</code></pre></div>\n<p><a href=\"https://github.com/aws-amplify/amplify-android/blob/main/aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/transfer/TransferWorkerObserver.kt\">TransferWorkerObserver</a> 클래스에서 동일한 전송 태그에 대해 <code class=\"language-text\">LiveData.observeForever()</code>가 중복 호출되며, 여러 관찰자가 등록된 것으로 보였고, 이는 <code class=\"language-text\">LiveData</code> 내부의 <a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/IdentityHashMap.html\">IdentityHashMap</a>이 과도하게 커져 메모리 할당에 실패하게 만들고, 특히 <code class=\"language-text\">Room</code> 라이브러리의 <a href=\"https://developer.android.com/reference/androidx/room/InvalidationTracker\">InvalidationTracker</a>와 연계된 <code class=\"language-text\">LiveData</code> 사용으로 메모리 사용량이 더 증가한 것으로 판단하였습니다.</p>\n<h3 id=\"이슈-등록하기\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EC%8A%88-%EB%93%B1%EB%A1%9D%ED%95%98%EA%B8%B0\" aria-label=\"이슈 등록하기 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>이슈 등록하기</h3>\n<p>저는 먼저 이 문제를 공유하기 위해 템플릿에 맞추어 <a href=\"https://github.com/aws-amplify/amplify-android/issues/2840\">이슈</a>를 등록해주었습니다.</p>\n<p>다만, <strong>보안상</strong> 회사 코드를 전부 스니펫에 첨부할 수는 없었기 때문에 민감한 코드는 전부 제거하고 핵심 로직만 다시 재작성하였습니다. 이슈란에 첨부한 코드 스니펫은 다음과 같았습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token annotation builtin\">@HiltWorker</span>\n<span class=\"token keyword\">class</span> LogUploadWorker <span class=\"token annotation builtin\">@AssistedInject</span> <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>\n    <span class=\"token annotation builtin\">@Assisted</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> appContext<span class=\"token operator\">:</span> Context<span class=\"token punctuation\">,</span>\n    <span class=\"token annotation builtin\">@Assisted</span> workerParams<span class=\"token operator\">:</span> WorkerParameters<span class=\"token punctuation\">,</span>\n    <span class=\"token annotation builtin\">@Dispatcher</span><span class=\"token punctuation\">(</span>IO<span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> ioDispatcher<span class=\"token operator\">:</span> CoroutineDispatcher\n<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">CoroutineWorker</span><span class=\"token punctuation\">(</span>appContext<span class=\"token punctuation\">,</span> workerParams<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">getForegroundInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ForegroundInfo <span class=\"token operator\">=</span>\n        appContext<span class=\"token punctuation\">.</span><span class=\"token function\">logSyncForegroundInfo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">override</span> <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">doWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Result <span class=\"token operator\">=</span> <span class=\"token function\">withContext</span><span class=\"token punctuation\">(</span>ioDispatcher<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">val</span> externalFilesDirPath <span class=\"token operator\">=</span> inputData<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"externalFilesDirPath\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">val</span> externalFilesDir <span class=\"token operator\">=</span> externalFilesDirPath<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">let</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">File</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>externalFilesDir <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> externalFilesDir<span class=\"token punctuation\">.</span><span class=\"token function\">exists</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">uploadLogFiles</span><span class=\"token punctuation\">(</span>externalFilesDir<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> Exception<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            Timber<span class=\"token punctuation\">.</span><span class=\"token function\">e</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"Log upload exception: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">e<span class=\"token punctuation\">.</span>message</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n            Result<span class=\"token punctuation\">.</span><span class=\"token function\">retry</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        Result<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation builtin\">@OptIn</span><span class=\"token punctuation\">(</span>ExperimentalCoroutinesApi<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">,</span> FlowPreview<span class=\"token operator\">::</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">uploadLogFiles</span><span class=\"token punctuation\">(</span>externalFilesDir<span class=\"token operator\">:</span> File<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> curFiles <span class=\"token operator\">=</span> externalFilesDir<span class=\"token punctuation\">.</span><span class=\"token function\">listFiles</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span> <span class=\"token punctuation\">{</span> file <span class=\"token operator\">-></span>\n            System<span class=\"token punctuation\">.</span><span class=\"token function\">currentTimeMillis</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> file<span class=\"token punctuation\">.</span><span class=\"token function\">lastModified</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> TWO_WEEK_TIME_MILLIS\n        <span class=\"token punctuation\">}</span><span class=\"token operator\">?</span><span class=\"token punctuation\">.</span><span class=\"token function\">sortedByDescending</span> <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span><span class=\"token function\">lastModified</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>curFiles<span class=\"token punctuation\">.</span><span class=\"token function\">isNullOrEmpty</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            Timber<span class=\"token punctuation\">.</span><span class=\"token function\">i</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"No log files or directory found.\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">return</span>\n        <span class=\"token punctuation\">}</span>\n        \n        <span class=\"token keyword\">val</span> environmentPrefix <span class=\"token operator\">=</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>BuildConfig<span class=\"token punctuation\">.</span>DEBUG<span class=\"token punctuation\">)</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"debug\"</span></span> <span class=\"token keyword\">else</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"release\"</span></span>\n        <span class=\"token keyword\">val</span> dateFormat <span class=\"token operator\">=</span> <span class=\"token function\">SimpleDateFormat</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"yyyy-MM-dd\"</span></span><span class=\"token punctuation\">,</span> Locale<span class=\"token punctuation\">.</span><span class=\"token function\">getDefault</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        curFiles<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span> <span class=\"token punctuation\">{</span> file <span class=\"token operator\">-></span>\n            <span class=\"token keyword\">val</span> date <span class=\"token operator\">=</span> dateFormat<span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span><span class=\"token function\">Date</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">lastModified</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">val</span> fileIndex <span class=\"token operator\">=</span> file<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span><span class=\"token function\">substringBefore</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"_logs.txt\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">takeLastWhile</span> <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span><span class=\"token function\">isDigit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">val</span> key <span class=\"token operator\">=</span> <span class=\"token string-literal singleline\"><span class=\"token string\">\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">environmentPrefix</span></span><span class=\"token string\">/sample/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">date</span></span><span class=\"token string\">/log</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">fileIndex</span></span><span class=\"token string\">.txt\"</span></span>\n\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">val</span> result <span class=\"token operator\">=</span> Amplify<span class=\"token punctuation\">.</span>Storage<span class=\"token punctuation\">.</span><span class=\"token function\">uploadFile</span><span class=\"token punctuation\">(</span>\n                    StoragePath<span class=\"token punctuation\">.</span><span class=\"token function\">fromString</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"public/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">$</span><span class=\"token expression\">key</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                    file\n                <span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">result</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                Timber<span class=\"token punctuation\">.</span><span class=\"token function\">i</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"Log file upload successful: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">result<span class=\"token punctuation\">.</span>path</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token operator\">:</span> Exception<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                Timber<span class=\"token punctuation\">.</span><span class=\"token function\">e</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"Log file upload failed: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">error<span class=\"token punctuation\">.</span>message</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> - </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token expression\">error<span class=\"token punctuation\">.</span>cause</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">companion</span> <span class=\"token keyword\">object</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">private</span> <span class=\"token keyword\">const</span> <span class=\"token keyword\">val</span> TWO_WEEK_TIME_MILLIS <span class=\"token operator\">=</span> <span class=\"token number\">14</span> <span class=\"token operator\">*</span> <span class=\"token number\">24</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">1000L</span>\n\n        <span class=\"token keyword\">fun</span> <span class=\"token function\">startUpUploadWork</span><span class=\"token punctuation\">(</span>\n            externalFilesDirPath<span class=\"token operator\">:</span> File<span class=\"token operator\">?</span>\n        <span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> PeriodicWorkRequestBuilder<span class=\"token operator\">&lt;</span>LogUploadWorker<span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n            <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> TimeUnit<span class=\"token punctuation\">.</span>HOURS<span class=\"token punctuation\">,</span>\n            <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> TimeUnit<span class=\"token punctuation\">.</span>MINUTES\n        <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">setConstraints</span><span class=\"token punctuation\">(</span>LogSyncConstraints<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">setBackoffCriteria</span><span class=\"token punctuation\">(</span>\n                BackoffPolicy<span class=\"token punctuation\">.</span>LINEAR<span class=\"token punctuation\">,</span>\n                MIN_BACKOFF_MILLIS<span class=\"token punctuation\">,</span>\n                TimeUnit<span class=\"token punctuation\">.</span>MILLISECONDS\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">setInputData</span><span class=\"token punctuation\">(</span>\n                Data<span class=\"token punctuation\">.</span><span class=\"token function\">Builder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">putString</span><span class=\"token punctuation\">(</span><span class=\"token string-literal singleline\"><span class=\"token string\">\"externalFilesDirPath\"</span></span><span class=\"token punctuation\">,</span> externalFilesDirPath<span class=\"token operator\">?</span><span class=\"token punctuation\">.</span>absolutePath<span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>간단하게 위 스니펫의 로직을 설명하면, 먼저 로그 파일 디렉터리 경로를 기반으로 파일 객체를 생성하고, <strong>2주</strong> 이내에 수정된 파일들을 필터링하며, 최근 수정된 순서로 정렬한 뒤, 예외가 발생했을 때에는 <code class=\"language-text\">선형 재시도</code> 정책을 따르도록 설정해주었고, 각 파일에 대해 <code class=\"language-text\">빌드타입</code>에 따른 정보와, 파일의 수정 날짜, 파일 이름의 인덱스를 조합하여 AWS S3에 저장할 키를 구성하고, 이후 파일을 업로드하고 그 결과를 Timber 로그로 남기는 흐름입니다. 이 작업은 <code class=\"language-text\">주기적으로 실행되는 작업</code>에 해당하므로 <a href=\"https://developer.android.com/topic/libraries/architecture/workmanager?hl=ko\">Workmanager</a>의 <a href=\"https://developer.android.com/reference/androidx/work/PeriodicWorkRequest.Builder\">PeriodicWorkRequest.Builder</a>를 활용하였습니다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/1f60a18ae5a15a527739d5f75a973dec/5dd2a/aws-amplify-issue-comment.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 26.47058823529412%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA4ElEQVR42mWP3XKCMBSEua6tIoSfQCABDViqFLS2jn2Bvv8LbXMOI2WmF99s9iRnZ+ON9x/Y0w22G6DtEap+RVpaiKxC5BCStGZoNiMNwtQgSDSkbiDLBhuRwVv5MbZxjsp2KOsWRdVC7w5OG+cP7JWx7JVp+EzvZFHDFxKB2w0TxboOEnjPfsSDrr/gbbji/XLDafxk35+/cHSz3s368wTdDR93jNdvDs7LHXK9R6qqv0BKN/up4QNqNLVsZ320U87TLyhktREM5cyBfpS5lgWe1iFf/GOxtNSXbcwhS34BAD6GLRjpV7kAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='aws amplify issue comment' title='' src='/static/1f60a18ae5a15a527739d5f75a973dec/ca1dc/aws-amplify-issue-comment.png' srcset='/static/1f60a18ae5a15a527739d5f75a973dec/e7570/aws-amplify-issue-comment.png 170w,\n/static/1f60a18ae5a15a527739d5f75a973dec/f46e7/aws-amplify-issue-comment.png 340w,\n/static/1f60a18ae5a15a527739d5f75a973dec/ca1dc/aws-amplify-issue-comment.png 680w,\n/static/1f60a18ae5a15a527739d5f75a973dec/02d09/aws-amplify-issue-comment.png 1020w,\n/static/1f60a18ae5a15a527739d5f75a973dec/9d567/aws-amplify-issue-comment.png 1360w,\n/static/1f60a18ae5a15a527739d5f75a973dec/5dd2a/aws-amplify-issue-comment.png 1926w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>이후 해당 이슈란의 코멘트를 통해 메인테이너분들과 이슈의 발생 빈도와 문제 발생 기기의 스펙 정보들을 요청받았고, 당시에는 <a href=\"https://github.com/aws-amplify/amplify-android\">aws-amplify/amplify-android</a> 라이브러리 자체의 문제라기보다는 <code class=\"language-text\">내가 구현한 코드에 문제가 있었나?</code>, <code class=\"language-text\">OOM이 발생하지 않도록 더 최적화 할수는 없는가?</code>라고 고민을 하였고, 이를 해결하기 위해 아래의 개선작업들을 진행했습니다.</p>\n<ul>\n<li>로그 파일 리스트를 즉시 모두 메모리에 로드하지 않고, 필요한 시점에만 File 객체를 생성하도록 개선하기</li>\n<li>14일 이상된 오래된 로그 파일들을 주기적으로 삭제하여 처리해야할 로그 파일 수 자체를 줄이기</li>\n</ul>\n<p>하지만, 이러한 노력에도 불구하고 여전히 주기적으로 OOM 오류들이 수집되었습니다.</p>\n<h3 id=\"직접-수정해보자\" style=\"position:relative;\"><a href=\"#%EC%A7%81%EC%A0%91-%EC%88%98%EC%A0%95%ED%95%B4%EB%B3%B4%EC%9E%90\" aria-label=\"직접 수정해보자 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>직접 수정해보자</h3>\n<p>오픈소스와 관련된 활동을 한다면, 라이선스 규정을 잘 준수해야 합니다. 또한 오픈소스 프로젝트에 컨트리뷰션을 하기 전에는 <code class=\"language-text\">CONTRIBUTING.md</code> 파일을 꼼꼼하게 읽어 가이드라인을 잘 준수할 수 있도록 해야합니다.</p>\n<p>저는 직접 수정해보기로 마음먹었습니다. 수집된 크래시 리포트를 다시 분석하여 코드를 수정한 뒤 PR을 생성하였고, 수정된 코드는 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span>concurrent<span class=\"token punctuation\">.</span>ConcurrentHashMap\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> observedTags <span class=\"token operator\">=</span> ConcurrentHashMap<span class=\"token punctuation\">.</span>newKeySet<span class=\"token operator\">&lt;</span>String<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">attachObserver</span><span class=\"token punctuation\">(</span>tag<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">withContext</span><span class=\"token punctuation\">(</span>Dispatchers<span class=\"token punctuation\">.</span>Main<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>observedTags<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token label symbol\">@withContext</span>\n        <span class=\"token keyword\">val</span> liveData <span class=\"token operator\">=</span> workManager<span class=\"token punctuation\">.</span><span class=\"token function\">getWorkInfosByTagLiveData</span><span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span>\n        liveData<span class=\"token punctuation\">.</span><span class=\"token function\">observeForever</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token label symbol\">@TransferWorkerObserver</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">suspend</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">removeObserver</span><span class=\"token punctuation\">(</span>tag<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">withContext</span><span class=\"token punctuation\">(</span>Dispatchers<span class=\"token punctuation\">.</span>Main<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>observedTags<span class=\"token punctuation\">.</span><span class=\"token function\">remove</span><span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token label symbol\">@withContext</span>\n        workManager<span class=\"token punctuation\">.</span><span class=\"token function\">getWorkInfosByTagLiveData</span><span class=\"token punctuation\">(</span>tag<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">.</span><span class=\"token function\">removeObserver</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token label symbol\">@TransferWorkerObserver</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>AWS Amplify Storage 모듈의 <a href=\"https://github.com/aws-amplify/amplify-android/blob/main/aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/transfer/TransferWorkerObserver.kt\">TransferWorkerObserver</a> 클래스에 중복 관찰자 등록을 방지하는 로직을 추가하였고, <a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentHashMap.html\">ConcurrentHashMap</a>은 <code class=\"language-text\">thread-safe</code>하며, <code class=\"language-text\">ConcurrentHashMap.newKeySet()</code>은 <code class=\"language-text\">Set</code> 인터페이스를 제공해주는데, 태그가 이미 존재하면 <code class=\"language-text\">add()</code>는 <code class=\"language-text\">false</code>를 반환하고, 얼리 리턴을 통해 함수를 종료합니다. 마찬가지로 <code class=\"language-text\">remove()</code>는 태그가 <code class=\"language-text\">observedTags</code>에 없으면 false를 반환하고 함수를 종료시킵니다. 이를 통해 불필요한 중복된 태그 등록을 방지할 수 있도록 수정하였습니다.</p>\n<h3 id=\"뿌듯한-결과\" style=\"position:relative;\"><a href=\"#%EB%BF%8C%EB%93%AF%ED%95%9C-%EA%B2%B0%EA%B3%BC\" aria-label=\"뿌듯한 결과 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>뿌듯한 결과</h3>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/46bf8fdb3c0204b69df6052b2d090ede/46dcf/aws-amplify-approve-comment.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 32.94117647058823%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABLklEQVR42m2R3U7EIBCFe2ni1rawBVqgQH/3r2q88QV8/1c6DtTtauLFF5KBOZw5k53XBdXFIowXGD+ibhzR7XChkZdHosYhIZBXD6T20H5C6wZUdYvMhxGmX6GMh2g9uDRgJMKVxZEohUVRRwwK3uCFyT+CJVepT7uZBDWyourwOn1hOl0xX95JOCShphuSY9aO4OYKYebkhktyXNUkLBIHcq/sgOX2kabLnO/BGkOWZwgdUNNvESYtKnLHBDlOru0G1bmKcfgdaXqqOZRHGvl8WuCmFde3T4R5hZ9uCRNOkPRz043UsKHsAya7nWhGmgFlHPkp53DDgi5MaEig7TZMDHo/+4R2YyJGEce+81xsS4v5ZnklKTND21R0UadM4jbjozuHnw3/rsXm//gGPK21BL1vINcAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='aws amplify approve comment' title='' src='/static/46bf8fdb3c0204b69df6052b2d090ede/ca1dc/aws-amplify-approve-comment.png' srcset='/static/46bf8fdb3c0204b69df6052b2d090ede/e7570/aws-amplify-approve-comment.png 170w,\n/static/46bf8fdb3c0204b69df6052b2d090ede/f46e7/aws-amplify-approve-comment.png 340w,\n/static/46bf8fdb3c0204b69df6052b2d090ede/ca1dc/aws-amplify-approve-comment.png 680w,\n/static/46bf8fdb3c0204b69df6052b2d090ede/02d09/aws-amplify-approve-comment.png 1020w,\n/static/46bf8fdb3c0204b69df6052b2d090ede/9d567/aws-amplify-approve-comment.png 1360w,\n/static/46bf8fdb3c0204b69df6052b2d090ede/46dcf/aws-amplify-approve-comment.png 1948w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>메인테이너분으로부터 좋은 아이디어라는 의견과 함께 몇 가지 제안사항들을 수정한 뒤에 최종 승인이 되었고, <a href=\"https://github.com/aws-amplify/amplify-android/releases/tag/release_v2.27.1\">2.27.1</a> 버전에 해당 작업이 반영되어 릴리즈 되었습니다 🎉 </p>\n<p>이러한 경험을 통해서 회사 프로젝트에서 사용중인 오픈소스 라이브러리 오류를 발견하면 적극적으로 PR을 올려 기여하고 문제를 수정하는 것이 중요하다고 느꼈고, 자주 사용했지만 몰랐던 라이브러리의 내부 동작을 살펴보는 경험을 하게 되었습니다.</p>\n<h3 id=\"아쉬웠던-점-그리고-반성\" style=\"position:relative;\"><a href=\"#%EC%95%84%EC%89%AC%EC%9B%A0%EB%8D%98-%EC%A0%90-%EA%B7%B8%EB%A6%AC%EA%B3%A0-%EB%B0%98%EC%84%B1\" aria-label=\"아쉬웠던 점 그리고 반성 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>아쉬웠던 점, 그리고 반성</h3>\n<blockquote>\n<p>만약 Heap Dump를 더욱 끈질기게 분석했더라면, 문제의 근본 원인을 더 빠르게 파악하고 보다 더 근거있는 이슈 트래킹에 큰 도움이 되었지 않았을까?</p>\n</blockquote>","frontmatter":{"title":"AWS Amplify Android 오픈소스 기여하기","date":"February 25, 2025","update":"February 25, 2025","tags":["opensource"],"series":null},"fields":{"slug":"/aws-amplify/","readingTime":{"minutes":8.285}}},"seriesList":{"edges":[{"node":{"id":"8e7bdff8-a60d-50a5-aa84-fbc6f7569ebb","fields":{"slug":"/aws-amplify/"},"frontmatter":{"title":"AWS Amplify Android 오픈소스 기여하기"}}},{"node":{"id":"304406d0-f9d7-5cb1-9204-66cda7adc7e3","fields":{"slug":"/fitts-law/"},"frontmatter":{"title":"안드로이드 개발자가 놓치기 쉬운 UX (feat. 피츠의 법칙)"}}},{"node":{"id":"b6eb455b-15e0-51eb-8c18-31e889b742d5","fields":{"slug":"/junit4-junit5/"},"frontmatter":{"title":"JUnit4 vs JUnit5 그리고 Robolectric 호환성 문제 해결하기"}}},{"node":{"id":"438afae6-59fd-5aab-9adf-5c731d92309d","fields":{"slug":"/about/"},"frontmatter":{"title":"안녕하세요 김원석입니다"}}}]},"previous":{"fields":{"slug":"/jvm-under-the-hood/"},"frontmatter":{"title":"책 『JVM 밑바닥까지 파헤치기』 후기"}},"next":{"fields":{"slug":"/fitts-law/"},"frontmatter":{"title":"안드로이드 개발자가 놓치기 쉬운 UX (feat. 피츠의 법칙)"}}},"pageContext":{"id":"8e7bdff8-a60d-50a5-aa84-fbc6f7569ebb","series":null,"previousPostId":"d2ebdb60-2bb2-53a8-82d4-5766746f2c97","nextPostId":"304406d0-f9d7-5cb1-9204-66cda7adc7e3"}},"staticQueryHashes":[],"slicesMap":{}}