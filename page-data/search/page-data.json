{"componentChunkName":"component---src-pages-search-jsx","path":"/search/","result":{"data":{"allMarkdownRemark":{"nodes":[{"excerpt":"AWS AmplifyëŠ” ëª¨ë°”ì¼ ë° í”„ëŸ°íŠ¸ì—”ë“œ ê°œë°œìê°€ AWSì—ì„œ ì•ˆì „í•˜ê³  í™•ì¥ ê°€ëŠ¥í•œ í’€ìŠ¤íƒ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬ì¶•í•˜ê³  ë°°í¬í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ëŠ” ì œí’ˆì…ë‹ˆë‹¤. íšŒì‚¬ì—ì„œ ì„œë¹„ìŠ¤í•˜ê³  ìˆëŠ” í”„ë¡œì íŠ¸ì—ì„œ S3ë¡œ ë¡œê·¸ íŒŒì¼ì„ ì£¼ê¸°ì ìœ¼ë¡œ ì—…ë¡œë“œí•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê³  ê¾¸ì¤€íˆ ëª¨ë‹ˆí„°ë§í•˜ì˜€ëŠ”ë°, ì—¬ëŸ¬ Android ê¸°ê¸°ì—ì„œ java.lang.OutOfMemoryError ì˜¤ë¥˜â€¦","fields":{"slug":"/aws-amplify/"},"frontmatter":{"date":"February 25, 2025","title":"AWS Amplify Android ì˜¤í”ˆì†ŒìŠ¤ ê¸°ì—¬í•˜ê¸°","tags":["opensource"]},"rawMarkdownBody":"\nAWS AmplifyëŠ” ëª¨ë°”ì¼ ë° í”„ëŸ°íŠ¸ì—”ë“œ ê°œë°œìê°€ AWSì—ì„œ ì•ˆì „í•˜ê³  í™•ì¥ ê°€ëŠ¥í•œ í’€ìŠ¤íƒ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ êµ¬ì¶•í•˜ê³  ë°°í¬í•  ìˆ˜ ìˆë„ë¡ ì§€ì›í•˜ëŠ” ì œí’ˆì…ë‹ˆë‹¤. íšŒì‚¬ì—ì„œ ì„œë¹„ìŠ¤í•˜ê³  ìˆëŠ” í”„ë¡œì íŠ¸ì—ì„œ S3ë¡œ ë¡œê·¸ íŒŒì¼ì„ ì£¼ê¸°ì ìœ¼ë¡œ ì—…ë¡œë“œí•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê³  ê¾¸ì¤€íˆ ëª¨ë‹ˆí„°ë§í•˜ì˜€ëŠ”ë°, ì—¬ëŸ¬ Android ê¸°ê¸°ì—ì„œ [java.lang.OutOfMemoryError](https://docs.oracle.com/javase/8/docs/technotes/guides/troubleshoot/memleaks002.html) ì˜¤ë¥˜ê°€ ë°˜ë³µì ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ê²ƒì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤.\n\n### ì›ì¸ì„ ë¶„ì„í•´ë³´ì\nìˆ˜ì§‘ëœ í¬ë˜ì‹œ ë¦¬í¬íŠ¸ë¥¼ ìš”ì•½í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì•˜ìŠµë‹ˆë‹¤.\n```text\nFatal Exception: java.lang.OutOfMemoryError: Failed to allocate a 8388620 byte allocation with 8388608 free bytes and 19MB until OOM\n       at java.util.IdentityHashMap.resize(IdentityHashMap.java:476)\n       at java.util.IdentityHashMap.put(IdentityHashMap.java:452)\n       ...\n       at com.amplifyframework.storage.s3.transfer.TransferWorkerObserver$attachObserver$2.invokeSuspend(TransferWorkerObserver.kt:199)\n```\n\n[TransferWorkerObserver](https://github.com/aws-amplify/amplify-android/blob/main/aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/transfer/TransferWorkerObserver.kt) í´ë˜ìŠ¤ì—ì„œ ë™ì¼í•œ ì „ì†¡ íƒœê·¸ì— ëŒ€í•´ `LiveData.observeForever()`ê°€ ì¤‘ë³µ í˜¸ì¶œë˜ë©°, ì—¬ëŸ¬ ê´€ì°°ìê°€ ë“±ë¡ëœ ê²ƒìœ¼ë¡œ ë³´ì˜€ê³ , ì´ëŠ” `LiveData` ë‚´ë¶€ì˜ [IdentityHashMap](https://docs.oracle.com/javase/8/docs/api/java/util/IdentityHashMap.html)ì´ ê³¼ë„í•˜ê²Œ ì»¤ì ¸ ë©”ëª¨ë¦¬ í• ë‹¹ì— ì‹¤íŒ¨í•˜ê²Œ ë§Œë“¤ê³ , íŠ¹íˆ `Room` ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ [InvalidationTracker](https://developer.android.com/reference/androidx/room/InvalidationTracker)ì™€ ì—°ê³„ëœ `LiveData` ì‚¬ìš©ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ ë” ì¦ê°€í•œ ê²ƒìœ¼ë¡œ íŒë‹¨í•˜ì˜€ìŠµë‹ˆë‹¤.\n\n### ì´ìŠˆ ë“±ë¡í•˜ê¸°\nì €ëŠ” ë¨¼ì € ì´ ë¬¸ì œë¥¼ ê³µìœ í•˜ê¸° ìœ„í•´ í…œí”Œë¦¿ì— ë§ì¶”ì–´ [ì´ìŠˆ](https://github.com/aws-amplify/amplify-android/issues/2840)ë¥¼ ë“±ë¡í•´ì£¼ì—ˆìŠµë‹ˆë‹¤.\n\në‹¤ë§Œ, **ë³´ì•ˆìƒ** íšŒì‚¬ ì½”ë“œë¥¼ ì „ë¶€ ìŠ¤ë‹ˆí«ì— ì²¨ë¶€í•  ìˆ˜ëŠ” ì—†ì—ˆê¸° ë•Œë¬¸ì— ë¯¼ê°í•œ ì½”ë“œëŠ” ì „ë¶€ ì œê±°í•˜ê³  í•µì‹¬ ë¡œì§ë§Œ ë‹¤ì‹œ ì¬ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤. ì´ìŠˆë€ì— ì²¨ë¶€í•œ ì½”ë“œ ìŠ¤ë‹ˆí«ì€ ë‹¤ìŒê³¼ ê°™ì•˜ìŠµë‹ˆë‹¤.\n\n```kotlin\n@HiltWorker\nclass LogUploadWorker @AssistedInject constructor(\n    @Assisted private val appContext: Context,\n    @Assisted workerParams: WorkerParameters,\n    @Dispatcher(IO) private val ioDispatcher: CoroutineDispatcher\n) : CoroutineWorker(appContext, workerParams) {\n\n    override suspend fun getForegroundInfo(): ForegroundInfo =\n        appContext.logSyncForegroundInfo()\n\n    override suspend fun doWork(): Result = withContext(ioDispatcher) {\n        try {\n            val externalFilesDirPath = inputData.getString(\"externalFilesDirPath\")\n            val externalFilesDir = externalFilesDirPath?.let { File(it) }\n            if (externalFilesDir != null && externalFilesDir.exists()) {\n                uploadLogFiles(externalFilesDir)\n            }\n        } catch (e: Exception) {\n            Timber.e(\"Log upload exception: ${e.message}\")\n            Result.retry()\n        }\n        Result.success()\n    }\n\n    @OptIn(ExperimentalCoroutinesApi::class, FlowPreview::class)\n    private suspend fun uploadLogFiles(externalFilesDir: File) {\n        val curFiles = externalFilesDir.listFiles()?.filter { file ->\n            System.currentTimeMillis() - file.lastModified() < TWO_WEEK_TIME_MILLIS\n        }?.sortedByDescending { it.lastModified() }\n\n        if (curFiles.isNullOrEmpty()) {\n            Timber.i(\"No log files or directory found.\")\n            return\n        }\n        \n        val environmentPrefix = if (BuildConfig.DEBUG) \"debug\" else \"release\"\n        val dateFormat = SimpleDateFormat(\"yyyy-MM-dd\", Locale.getDefault())\n\n        curFiles.forEach { file ->\n            val date = dateFormat.format(Date(file.lastModified()))\n            val fileIndex = file.name.substringBefore(\"_logs.txt\").takeLastWhile { it.isDigit() }\n            val key = \"$environmentPrefix/sample/$date/log$fileIndex.txt\"\n\n            try {\n                val result = Amplify.Storage.uploadFile(\n                    StoragePath.fromString(\"public/$key\"),\n                    file\n                ).result()\n                Timber.i(\"Log file upload successful: ${result.path}\")\n            } catch (error: Exception) {\n                Timber.e(\"Log file upload failed: ${error.message} - ${error.cause}\")\n            }\n        }\n    }\n\n    companion object {\n        private const val TWO_WEEK_TIME_MILLIS = 14 * 24 * 60 * 60 * 1000L\n\n        fun startUpUploadWork(\n            externalFilesDirPath: File?\n        ) = PeriodicWorkRequestBuilder<LogUploadWorker>(\n            1, TimeUnit.HOURS,\n            5, TimeUnit.MINUTES\n        )\n            .setConstraints(LogSyncConstraints)\n            .setBackoffCriteria(\n                BackoffPolicy.LINEAR,\n                MIN_BACKOFF_MILLIS,\n                TimeUnit.MILLISECONDS\n            )\n            .setInputData(\n                Data.Builder()\n                    .putString(\"externalFilesDirPath\", externalFilesDirPath?.absolutePath)\n                    .build()\n            )\n            .build()\n    }\n}\n```\n\nê°„ë‹¨í•˜ê²Œ ìœ„ ìŠ¤ë‹ˆí«ì˜ ë¡œì§ì„ ì„¤ëª…í•˜ë©´, ë¨¼ì € ë¡œê·¸ íŒŒì¼ ë””ë ‰í„°ë¦¬ ê²½ë¡œë¥¼ ê¸°ë°˜ìœ¼ë¡œ íŒŒì¼ ê°ì²´ë¥¼ ìƒì„±í•˜ê³ , **2ì£¼** ì´ë‚´ì— ìˆ˜ì •ëœ íŒŒì¼ë“¤ì„ í•„í„°ë§í•˜ë©°, ìµœê·¼ ìˆ˜ì •ëœ ìˆœì„œë¡œ ì •ë ¬í•œ ë’¤, ì˜ˆì™¸ê°€ ë°œìƒí–ˆì„ ë•Œì—ëŠ” `ì„ í˜• ì¬ì‹œë„` ì •ì±…ì„ ë”°ë¥´ë„ë¡ ì„¤ì •í•´ì£¼ì—ˆê³ , ê° íŒŒì¼ì— ëŒ€í•´ `ë¹Œë“œíƒ€ì…`ì— ë”°ë¥¸ ì •ë³´ì™€, íŒŒì¼ì˜ ìˆ˜ì • ë‚ ì§œ, íŒŒì¼ ì´ë¦„ì˜ ì¸ë±ìŠ¤ë¥¼ ì¡°í•©í•˜ì—¬ AWS S3ì— ì €ì¥í•  í‚¤ë¥¼ êµ¬ì„±í•˜ê³ , ì´í›„ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ê·¸ ê²°ê³¼ë¥¼ Timber ë¡œê·¸ë¡œ ë‚¨ê¸°ëŠ” íë¦„ì…ë‹ˆë‹¤. ì´ ì‘ì—…ì€ `ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” ì‘ì—…`ì— í•´ë‹¹í•˜ë¯€ë¡œ [Workmanager](https://developer.android.com/topic/libraries/architecture/workmanager?hl=ko)ì˜ [PeriodicWorkRequest.Builder](https://developer.android.com/reference/androidx/work/PeriodicWorkRequest.Builder)ë¥¼ í™œìš©í•˜ì˜€ìŠµë‹ˆë‹¤.\n\n![aws-amplify-issue-comment](aws-amplify-issue-comment.png)\n\nì´í›„ í•´ë‹¹ ì´ìŠˆë€ì˜ ì½”ë©˜íŠ¸ë¥¼ í†µí•´ ë©”ì¸í…Œì´ë„ˆë¶„ë“¤ê³¼ ì´ìŠˆì˜ ë°œìƒ ë¹ˆë„ì™€ ë¬¸ì œ ë°œìƒ ê¸°ê¸°ì˜ ìŠ¤í™ ì •ë³´ë“¤ì„ ìš”ì²­ë°›ì•˜ê³ , ë‹¹ì‹œì—ëŠ” [aws-amplify/amplify-android](https://github.com/aws-amplify/amplify-android) ë¼ì´ë¸ŒëŸ¬ë¦¬ ìì²´ì˜ ë¬¸ì œë¼ê¸°ë³´ë‹¤ëŠ” `ë‚´ê°€ êµ¬í˜„í•œ ì½”ë“œì— ë¬¸ì œê°€ ìˆì—ˆë‚˜?`, `OOMì´ ë°œìƒí•˜ì§€ ì•Šë„ë¡ ë” ìµœì í™” í• ìˆ˜ëŠ” ì—†ëŠ”ê°€?`ë¼ê³  ê³ ë¯¼ì„ í•˜ì˜€ê³ , ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì•„ë˜ì˜ ê°œì„ ì‘ì—…ë“¤ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤.\n\n- ë¡œê·¸ íŒŒì¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ì¦‰ì‹œ ëª¨ë‘ ë©”ëª¨ë¦¬ì— ë¡œë“œí•˜ì§€ ì•Šê³ , í•„ìš”í•œ ì‹œì ì—ë§Œ File ê°ì²´ë¥¼ ìƒì„±í•˜ë„ë¡ ê°œì„ í•˜ê¸°\n- 14ì¼ ì´ìƒëœ ì˜¤ë˜ëœ ë¡œê·¸ íŒŒì¼ë“¤ì„ ì£¼ê¸°ì ìœ¼ë¡œ ì‚­ì œí•˜ì—¬ ì²˜ë¦¬í•´ì•¼í•  ë¡œê·¸ íŒŒì¼ ìˆ˜ ìì²´ë¥¼ ì¤„ì´ê¸°\n\ní•˜ì§€ë§Œ, ì´ëŸ¬í•œ ë…¸ë ¥ì—ë„ ë¶ˆêµ¬í•˜ê³  ì—¬ì „íˆ ì£¼ê¸°ì ìœ¼ë¡œ OOM ì˜¤ë¥˜ë“¤ì´ ìˆ˜ì§‘ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n### ì§ì ‘ ìˆ˜ì •í•´ë³´ì\nì˜¤í”ˆì†ŒìŠ¤ì™€ ê´€ë ¨ëœ í™œë™ì„ í•œë‹¤ë©´, ë¼ì´ì„ ìŠ¤ ê·œì •ì„ ì˜ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤. ë˜í•œ ì˜¤í”ˆì†ŒìŠ¤ í”„ë¡œì íŠ¸ì— ì»¨íŠ¸ë¦¬ë·°ì…˜ì„ í•˜ê¸° ì „ì—ëŠ” `CONTRIBUTING.md` íŒŒì¼ì„ ê¼¼ê¼¼í•˜ê²Œ ì½ì–´ ê°€ì´ë“œë¼ì¸ì„ ì˜ ì¤€ìˆ˜í•  ìˆ˜ ìˆë„ë¡ í•´ì•¼í•©ë‹ˆë‹¤.\n\nì €ëŠ” ì§ì ‘ ìˆ˜ì •í•´ë³´ê¸°ë¡œ ë§ˆìŒë¨¹ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì§‘ëœ í¬ë˜ì‹œ ë¦¬í¬íŠ¸ë¥¼ ë‹¤ì‹œ ë¶„ì„í•˜ì—¬ ì½”ë“œë¥¼ ìˆ˜ì •í•œ ë’¤ PRì„ ìƒì„±í•˜ì˜€ê³ , ìˆ˜ì •ëœ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.\n\n```kotlin\nimport java.util.concurrent.ConcurrentHashMap\n\nprivate val observedTags = ConcurrentHashMap.newKeySet<String>()\n\nprivate suspend fun attachObserver(tag: String) {\n    withContext(Dispatchers.Main) {\n        if (!observedTags.add(tag)) return@withContext\n        val liveData = workManager.getWorkInfosByTagLiveData(tag)\n        liveData.observeForever(this@TransferWorkerObserver)\n    }\n}\n\nprivate suspend fun removeObserver(tag: String) {\n    withContext(Dispatchers.Main) {\n        if (!observedTags.remove(tag)) return@withContext\n        workManager.getWorkInfosByTagLiveData(tag)\n            .removeObserver(this@TransferWorkerObserver)\n    }\n}\n```\n\nAWS Amplify Storage ëª¨ë“ˆì˜ [TransferWorkerObserver](https://github.com/aws-amplify/amplify-android/blob/main/aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/transfer/TransferWorkerObserver.kt) í´ë˜ìŠ¤ì— ì¤‘ë³µ ê´€ì°°ì ë“±ë¡ì„ ë°©ì§€í•˜ëŠ” ë¡œì§ì„ ì¶”ê°€í•˜ì˜€ê³ , [ConcurrentHashMap](https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/ConcurrentHashMap.html)ì€ `thread-safe`í•˜ë©°, `ConcurrentHashMap.newKeySet()`ì€ `Set` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•´ì£¼ëŠ”ë°, íƒœê·¸ê°€ ì´ë¯¸ ì¡´ì¬í•˜ë©´ `add()`ëŠ” `false`ë¥¼ ë°˜í™˜í•˜ê³ , ì–¼ë¦¬ ë¦¬í„´ì„ í†µí•´ í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤. ë§ˆì°¬ê°€ì§€ë¡œ `remove()`ëŠ” íƒœê·¸ê°€ `observedTags`ì— ì—†ìœ¼ë©´ falseë¥¼ ë°˜í™˜í•˜ê³  í•¨ìˆ˜ë¥¼ ì¢…ë£Œì‹œí‚µë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ë¶ˆí•„ìš”í•œ ì¤‘ë³µëœ íƒœê·¸ ë“±ë¡ì„ ë°©ì§€í•  ìˆ˜ ìˆë„ë¡ ìˆ˜ì •í•˜ì˜€ìŠµë‹ˆë‹¤.\n\n### ë¿Œë“¯í•œ ê²°ê³¼\n![aws-amplify-approve-comment](aws-amplify-approve-comment.png)\n\në©”ì¸í…Œì´ë„ˆë¶„ìœ¼ë¡œë¶€í„° ì¢‹ì€ ì•„ì´ë””ì–´ë¼ëŠ” ì˜ê²¬ê³¼ í•¨ê»˜ ëª‡ ê°€ì§€ ì œì•ˆì‚¬í•­ë“¤ì„ ìˆ˜ì •í•œ ë’¤ì— ìµœì¢… ìŠ¹ì¸ì´ ë˜ì—ˆê³ , [2.27.1](https://github.com/aws-amplify/amplify-android/releases/tag/release_v2.27.1) ë²„ì „ì— í•´ë‹¹ ì‘ì—…ì´ ë°˜ì˜ë˜ì–´ ë¦´ë¦¬ì¦ˆ ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‰ \n\nì´ëŸ¬í•œ ê²½í—˜ì„ í†µí•´ì„œ íšŒì‚¬ í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©ì¤‘ì¸ ì˜¤í”ˆì†ŒìŠ¤ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì˜¤ë¥˜ë¥¼ ë°œê²¬í•˜ë©´ ì ê·¹ì ìœ¼ë¡œ PRì„ ì˜¬ë ¤ ê¸°ì—¬í•˜ê³  ë¬¸ì œë¥¼ ìˆ˜ì •í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤ê³  ëŠê¼ˆê³ , ìì£¼ ì‚¬ìš©í–ˆì§€ë§Œ ëª°ëë˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ë‚´ë¶€ ë™ì‘ì„ ì‚´í´ë³´ëŠ” ê²½í—˜ì„ í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n### ì•„ì‰¬ì› ë˜ ì , ê·¸ë¦¬ê³  ë°˜ì„±\n\n> ë§Œì•½ Heap Dumpë¥¼ ë”ìš± ëˆì§ˆê¸°ê²Œ ë¶„ì„í–ˆë”ë¼ë©´, ë¬¸ì œì˜ ê·¼ë³¸ ì›ì¸ì„ ë” ë¹ ë¥´ê²Œ íŒŒì•…í•˜ê³  ë³´ë‹¤ ë” ê·¼ê±°ìˆëŠ” ì´ìŠˆ íŠ¸ë˜í‚¹ì— í° ë„ì›€ì´ ë˜ì—ˆì§€ ì•Šì•˜ì„ê¹Œ?"}]}},"pageContext":{}},"staticQueryHashes":[],"slicesMap":{}}